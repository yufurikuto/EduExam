generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Teacher {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())

  subjects  Subject[]
  exams     Exam[]
}

model Subject {
  id        String @id @default(uuid())
  name      String
  color     String?
  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])
  exams     Exam[]

  @@unique([name, teacherId]) // Avoid duplicate names for same teacher
}

model Exam {
  id          String   @id @default(uuid())
  title       String
  description String?
  
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  
  questions   Question[]
  results     ExamResult[]

  // Enhanced Settings
  timeLimit   Int?      // in minutes
  passingScore Int?
  isShuffle   Boolean   @default(false)
  className   String?   // Target class name

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id])
}

model Question {
  id            String @id @default(uuid())
  
  examId        String
  exam          Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  text          String
  type          String // "MULTIPLE_CHOICE", "TEXT", etc.
  options       Json?  // Array of strings or objects
  correctAnswer String?
  imageUrl      String?
  score         Int    @default(10)
  answerDetails AnswerDetail[]
}

model ExamResult {
  id            String   @id @default(uuid())
  examId        String
  exam          Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  studentName   String
  studentNumber String
  studentClass  String?
  score         Int
  answers       Json     // Student answers details (Keep for backup/compat)
  answerDetails AnswerDetail[] // New detailed answers
  
  submittedAt   DateTime @default(now())
}

model AnswerDetail {
  id              String   @id @default(uuid())
  
  examResultId    String
  examResult      ExamResult @relation(fields: [examResultId], references: [id], onDelete: Cascade)
  
  questionId      String
  question        Question @relation(fields: [questionId], references: [id])
  
  answer          String   // Student's answer
  isCorrect       Boolean
  score           Int
  teacherComment  String?
  isManualGraded  Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
